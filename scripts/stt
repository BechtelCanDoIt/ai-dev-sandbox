#!/bin/bash
# =============================================================================
# stt — Speech-to-Text via Whisper.cpp
# Gracefully skips if no audio hardware/PulseAudio is available.
# =============================================================================

set -e

WHISPER_BIN="${WHISPER_BIN:-/usr/local/bin/whisper-cli}"
MODEL_PATH="${WHISPER_MODEL_PATH:-/models/whisper}"
MODEL="${WHISPER_MODEL:-base.en}"
SAMPLE_RATE=16000
CHANNELS=1
RECORD_SECONDS="${STT_RECORD_SECONDS:-5}"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

show_help() {
    cat << EOF
Speech-to-Text using Whisper.cpp

Usage: stt [options] [audio_file]

Options:
  -m, --model MODEL     Whisper model (default: $MODEL)
  -t, --time SECONDS    Recording duration in seconds (default: $RECORD_SECONDS)
  -l, --language LANG   Language code (auto-detect if not .en model)
  -o, --output FILE     Save transcription to file
  -j, --json            Output JSON format
  -q, --quiet           Suppress progress messages
  -c, --continuous      Continuous mode with silence detection (Ctrl+C to stop)
  --list-models         List available models
  --list-devices        List audio input devices
  -h, --help            Show this help

Environment Variables:
  WHISPER_MODEL         Model name (default: base.en)
  WHISPER_MODEL_PATH    Model directory (default: /models/whisper)
  STT_RECORD_SECONDS    Recording duration (default: 5)
EOF
}

list_models() {
    echo "Available Whisper models in $MODEL_PATH:"
    for model in "$MODEL_PATH"/ggml-*.bin; do
        [ -f "$model" ] || continue
        local name size
        name=$(basename "$model" .bin | sed 's/ggml-//')
        size=$(du -h "$model" | cut -f1)
        echo "  $name ($size)"
    done
}

list_devices() {
    echo "Audio input devices:"
    if command -v pactl &>/dev/null; then
        pactl list sources short 2>/dev/null || echo "  PulseAudio not available"
    elif command -v arecord &>/dev/null; then
        arecord -l 2>/dev/null || echo "  No ALSA devices found"
    else
        echo "  No audio tools available"
    fi
}

# Returns 0 if any recording tool is usable, 1 otherwise
has_audio() {
    if command -v rec &>/dev/null && pactl info &>/dev/null 2>&1; then return 0; fi
    if command -v arecord &>/dev/null; then return 0; fi
    if command -v ffmpeg &>/dev/null && pactl info &>/dev/null 2>&1; then return 0; fi
    return 1
}

record_audio() {
    local output="$1" duration="$2" continuous="$3"

    if ! has_audio; then
        echo -e "${RED}[STT]${NC} No audio recording available (no PulseAudio or ALSA device)" >&2
        return 1
    fi

    echo -e "${BLUE}[STT]${NC} Recording audio..."

    if [ "$continuous" = "true" ]; then
        echo -e "${YELLOW}Press Ctrl+C to stop recording${NC}"
        if command -v rec &>/dev/null; then
            rec -q -r $SAMPLE_RATE -c $CHANNELS -b 16 "$output" \
                silence 1 0.1 1% 1 2.0 3% 2>/dev/null || true
        else
            arecord -q -f S16_LE -r $SAMPLE_RATE -c $CHANNELS "$output" 2>/dev/null || true
        fi
    else
        echo -e "${YELLOW}Recording for ${duration} seconds...${NC}"
        if command -v rec &>/dev/null; then
            rec -q -r $SAMPLE_RATE -c $CHANNELS -b 16 "$output" trim 0 "$duration" 2>/dev/null
        elif command -v arecord &>/dev/null; then
            arecord -q -f S16_LE -r $SAMPLE_RATE -c $CHANNELS -d "$duration" "$output" 2>/dev/null
        elif command -v ffmpeg &>/dev/null; then
            ffmpeg -y -f pulse -i default -t "$duration" -ar $SAMPLE_RATE -ac $CHANNELS "$output" 2>/dev/null
        fi
    fi

    echo -e "${GREEN}[STT]${NC} Recording complete"
}

transcribe() {
    local input="$1" model="$2" language="$3" json_output="$4" quiet="$5"
    local model_file="$MODEL_PATH/ggml-${model}.bin"

    if [ ! -f "$model_file" ]; then
        echo -e "${RED}[STT]${NC} Model not found: $model_file" >&2
        list_models >&2
        return 1
    fi

    [ "$quiet" != "true" ] && echo -e "${BLUE}[STT]${NC} Transcribing with model: $model"

    local args=(-m "$model_file" -f "$input" --no-timestamps -t 4)

    if [ -n "$language" ] && [[ ! "$model" =~ \.en$ ]]; then
        args+=(-l "$language")
    fi
    [ "$json_output" = "true" ] && args+=(--output-json)

    local result
    result=$("$WHISPER_BIN" "${args[@]}" 2>/dev/null)

    if [ "$json_output" = "true" ]; then
        echo "$result"
    else
        echo "$result" | sed 's/^\s*//;s/\s*$//' | grep -v '^\[' | tr -d '\n'
        echo ""
    fi
}

# =============================================================================
# Main
# =============================================================================
DURATION="$RECORD_SECONDS"
LANGUAGE=""
OUTPUT_FILE=""
JSON_OUTPUT="false"
QUIET="false"
CONTINUOUS="false"
INPUT_FILE=""

while [[ $# -gt 0 ]]; do
    case $1 in
        -m|--model)       MODEL="$2";       shift 2 ;;
        -t|--time)        DURATION="$2";    shift 2 ;;
        -l|--language)    LANGUAGE="$2";    shift 2 ;;
        -o|--output)      OUTPUT_FILE="$2"; shift 2 ;;
        -j|--json)        JSON_OUTPUT="true"; shift ;;
        -q|--quiet)       QUIET="true";     shift ;;
        -c|--continuous)  CONTINUOUS="true"; shift ;;
        --list-models)    list_models; exit 0 ;;
        --list-devices)   list_devices; exit 0 ;;
        -h|--help)        show_help; exit 0 ;;
        -*)               echo "Unknown option: $1" >&2; show_help >&2; exit 1 ;;
        *)                INPUT_FILE="$1"; shift ;;
    esac
done

# Check whisper binary
if [ ! -x "$WHISPER_BIN" ]; then
    echo -e "${RED}[STT]${NC} Whisper binary not found at $WHISPER_BIN" >&2
    exit 1
fi

# Record if no input file given
TEMP_AUDIO=""
if [ -z "$INPUT_FILE" ]; then
    TEMP_AUDIO=$(mktemp /tmp/stt_XXXXXX.wav)
    trap "rm -f '$TEMP_AUDIO'" EXIT

    if ! record_audio "$TEMP_AUDIO" "$DURATION" "$CONTINUOUS"; then
        echo -e "${YELLOW}[STT]${NC} Audio not available — nothing to transcribe" >&2
        exit 0   # Graceful exit, not an error
    fi
    INPUT_FILE="$TEMP_AUDIO"
fi

[ -f "$INPUT_FILE" ] || { echo -e "${RED}[STT]${NC} Audio file not found: $INPUT_FILE" >&2; exit 1; }

# Convert to 16kHz mono WAV if needed
CONVERTED="$INPUT_FILE"
if [[ "$INPUT_FILE" != *.wav ]]; then
    CONVERTED=$(mktemp /tmp/stt_conv_XXXXXX.wav)
    trap "rm -f '$CONVERTED'" EXIT
    ffmpeg -y -i "$INPUT_FILE" -ar $SAMPLE_RATE -ac $CHANNELS "$CONVERTED" 2>/dev/null
fi

RESULT=$(transcribe "$CONVERTED" "$MODEL" "$LANGUAGE" "$JSON_OUTPUT" "$QUIET")

if [ -n "$OUTPUT_FILE" ]; then
    echo "$RESULT" > "$OUTPUT_FILE"
    [ "$QUIET" != "true" ] && echo -e "${GREEN}[STT]${NC} Saved to: $OUTPUT_FILE"
else
    echo "$RESULT"
fi
